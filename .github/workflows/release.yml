name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    name: Create Release and Build APK
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Get version from tag
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
        
        # Extract changelog for this version from CHANGELOG.md if it exists
        if [ -f CHANGELOG.md ]; then
          echo "Reading changelog..."
        fi
    
    - name: Build Debug APK
      run: ./gradlew assembleDebug --no-daemon --stacktrace
    
    - name: Build Release APK (unsigned)
      run: ./gradlew assembleRelease --no-daemon --stacktrace
      continue-on-error: true
      id: release-build
    
    - name: Prepare release artifacts
      run: |
        mkdir -p release
        VERSION=${{ steps.version.outputs.version }}
        
        # Copy and rename debug APK
        if [ -f app/build/outputs/apk/debug/app-debug.apk ]; then
          cp app/build/outputs/apk/debug/app-debug.apk release/ABB-${VERSION}-debug.apk
          echo "âœ“ Debug APK prepared"
        fi
        
        # Copy and rename release APK if it was built
        if [ -f app/build/outputs/apk/release/app-release-unsigned.apk ]; then
          cp app/build/outputs/apk/release/app-release-unsigned.apk release/ABB-${VERSION}-release-unsigned.apk
          echo "âœ“ Release APK prepared (unsigned)"
        fi
        
        if [ -f app/build/outputs/apk/release/app-release.apk ]; then
          cp app/build/outputs/apk/release/app-release.apk release/ABB-${VERSION}-release.apk
          echo "âœ“ Release APK prepared (signed)"
        fi
        
        # Generate checksums
        cd release
        sha256sum *.apk > checksums-sha256.txt
        cd ..
        
        echo "=== Release artifacts ==="
        ls -lh release/
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: release/*
        draft: false
        prerelease: ${{ contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'rc') }}
        generate_release_notes: true
        body: |
          ## ğŸ“± ABB Robot Program Reader - ${{ steps.version.outputs.version }}
          
          ### ä¸‹è½½ / Downloads
          
          é€‰æ‹©åˆé€‚çš„ APK æ–‡ä»¶ä¸‹è½½ï¼š/ Choose the appropriate APK file to download:
          
          - **`ABB-${{ steps.version.outputs.version }}-debug.apk`**
            - ğŸ”§ å¼€å‘å’Œæµ‹è¯•ç‰ˆæœ¬ / Development and testing version
            - ğŸ“¦ åŒ…å«è°ƒè¯•ç¬¦å· / Includes debug symbols
            - âš ï¸ æ€§èƒ½å¯èƒ½è¾ƒæ…¢ / May have slower performance
          
          - **`ABB-${{ steps.version.outputs.version }}-release-unsigned.apk`**
            - ğŸš€ ç”Ÿäº§ç‰ˆæœ¬ï¼ˆæœªç­¾åï¼‰/ Production version (unsigned)
            - âœ¨ ä¼˜åŒ–æ€§èƒ½ / Optimized performance
            - âš ï¸ å¯èƒ½éœ€è¦ç‰¹æ®Šæƒé™å®‰è£… / May require special permissions to install
          
          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚ / System Requirements
          
          - Android 7.0 (API 24) æˆ–æ›´é«˜ç‰ˆæœ¬ / or higher
          - æœ€å°‘ 50 MB å¯ç”¨å­˜å‚¨ç©ºé—´ / Minimum 50 MB free storage
          
          ### ğŸ”§ å®‰è£…æ­¥éª¤ / Installation Steps
          
          1. ğŸ“¥ ä¸‹è½½å¯¹åº”çš„ APK æ–‡ä»¶ / Download the appropriate APK file
          2. âš™ï¸ åœ¨ Android è®¾å¤‡ä¸Šå¯ç”¨"æœªçŸ¥æ¥æº"å®‰è£… / Enable "Install from Unknown Sources" on your Android device
             - è®¾ç½® â†’ å®‰å…¨ â†’ æœªçŸ¥æ¥æº / Settings â†’ Security â†’ Unknown Sources
          3. ğŸ“² ç‚¹å‡» APK æ–‡ä»¶è¿›è¡Œå®‰è£… / Tap the APK file to install
          4. âœ… æŒ‰ç…§æç¤ºå®Œæˆå®‰è£… / Follow the prompts to complete installation
          
          ### ğŸ” æ ¡éªŒæ–‡ä»¶å®Œæ•´æ€§ / Verify File Integrity
          
          ä¸‹è½½ `checksums-sha256.txt` æ–‡ä»¶ï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤éªŒè¯ / Download `checksums-sha256.txt` and verify using:
          
          ```bash
          sha256sum -c checksums-sha256.txt
          ```
          
          ### ğŸ“ å˜æ›´æ—¥å¿— / Changelog
          
          æŸ¥çœ‹ä¸‹æ–¹è‡ªåŠ¨ç”Ÿæˆçš„å‘è¡Œè¯´æ˜ / See auto-generated release notes below
          
          ### ğŸ› é—®é¢˜åé¦ˆ / Bug Reports
          
          å¦‚æœ‰é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/OMOCV/Android/issues) é¡µé¢åé¦ˆ / 
          For issues, please report on the [Issues](https://github.com/OMOCV/Android/issues) page
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload artifacts for reference
      uses: actions/upload-artifact@v4
      with:
        name: release-artifacts-${{ steps.version.outputs.version }}
        path: release/
        retention-days: 90
